{% load static %}
<!DOCTYPE html>
<html lang="ru"
      x-data="{
        isSidebarOpen: false,
        sidebarCollapsed: localStorage.getItem('sidebarCollapsed') === 'true'
      }"
      x-watch="sidebarCollapsed, value => localStorage.setItem('sidebarCollapsed', value)"
>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}GAT Report{% endblock %}</title>

    <link rel="icon" href="{% static 'img/favicon.ico' %}" type="image/x-icon">

    <link href="{% static 'css/style.css' %}" rel="stylesheet">

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://unpkg.com/htmx.org@1.9.10"></script> {# –£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤–µ—Ä—Å–∏—è HTMX –∞–∫—Ç—É–∞–ª—å–Ω–∞ #}

    <style>
        [x-cloak] { display: none !important; }

        /* –°—Ç–∏–ª—å –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ HTMX */
        .htmx-indicator{
            display:none;
            opacity:0;
            transition: opacity 200ms ease-in;
        }
        .htmx-request .htmx-indicator{
            display:inline;
            opacity:1;
        }
        .htmx-request.htmx-indicator{
            display:inline;
            opacity:1;
        }
    </style>

    {% block head %}{% endblock %}
</head>

<body class="font-sans" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>

<div class="flex h-screen bg-gray-100"
     {# –°–ª—É—à–∞—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–¥–ª—è HTMX) #}
     @force-refresh.window="setTimeout(() => window.location.reload(), 500)"
>

    {# Mobile Sidebar #}
    <div class="lg:hidden">
        {# Overlay #}
        <div x-show="isSidebarOpen"
             x-transition:enter="transition-opacity ease-linear duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition-opacity ease-linear duration-300"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             @click="isSidebarOpen = false"
             class="fixed inset-0 bg-gray-600 bg-opacity-75 z-30" x-cloak>
        </div>

        {# Sidebar Panel #}
        <div x-show="isSidebarOpen"
             class="fixed inset-y-0 left-0 flex-shrink-0 z-40" x-cloak>
            <div class="relative flex-1 flex flex-col w-64 bg-gray-800"
                 x-transition:enter="transition ease-in-out duration-300 transform"
                 x-transition:enter-start="-translate-x-full"
                 x-transition:enter-end="translate-x-0"
                 x-transition:leave="transition ease-in-out duration-300 transform"
                 x-transition:leave-start="translate-x-0"
                 x-transition:leave-end="-translate-x-full">

                {# Close button #}
                <div class="absolute top-0 right-0 -mr-12 pt-2">
                    <button @click="isSidebarOpen = false" type="button" class="ml-1 flex items-center justify-center h-10 w-10 rounded-full focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white">
                        <span class="sr-only">Close sidebar</span>
                        <svg class="h-6 w-6 text-white" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                {# Sidebar Content #}
                {% include 'components/sidebar.html' %}
            </div>
        </div>
    </div>

    {# Desktop Sidebar #}
    <div class="hidden lg:flex lg:flex-shrink-0">
        <div class="flex flex-col transition-all duration-300 bg-gray-800"
             :class="{'w-64': !sidebarCollapsed, 'w-20': sidebarCollapsed}">
            {% include 'components/sidebar.html' %}
        </div>
    </div>

    {# Main content area #}
    <div class="flex flex-col w-0 flex-1 overflow-hidden">
        {% include 'components/header.html' %}
        {# --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º id="main-content" –∫ —Ç–µ–≥—É <main> --- #}
        <main class="flex-1 relative overflow-y-auto focus:outline-none" id="main-content">
            <div class="py-6 px-4 sm:px-6 lg:px-8">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>
</div>

{# Global Notifier (–¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π Django –∏ HTMX) #}
<div
    x-data="{ show: false, message: '', type: 'success' }"
    {# –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –æ—Ç HTMX (–∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ HX-Trigger) #}
    @htmx:after-swap.window="
        const triggerHeader = $event.detail.xhr.getResponseHeader('HX-Trigger');
        if (triggerHeader) {
            try {
                const triggers = JSON.parse(triggerHeader);
                if (triggers['show-message']) {
                    $dispatch('show-message', triggers['show-message']);
                }
            } catch (e) { console.error('Error parsing HX-Trigger header:', e); }
        }
    "
    {# –°–ª—É—à–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –æ—Ç Django messages (–∏–∑ —Å–∫—Ä–∏–ø—Ç–∞ –Ω–∏–∂–µ) #}
    @show-message.window="
        message = $event.detail.text;
        type = $event.detail.type; // 'success', 'error', 'info', 'warning'
        show = true;
        setTimeout(() => show = false, 5000); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º 5 —Å–µ–∫—É–Ω–¥
    "
    x-show="show"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0 transform translate-y-4"
    x-transition:enter-end="opacity-100 transform translate-y-0"
    x-transition:leave="transition ease-in duration-300"
    x-transition:leave-start="opacity-100 transform translate-y-0"
    x-transition:leave-end="opacity-0 transform translate-y-4"
    class="fixed top-5 left-1/2 -translate-x-1/2 z-[100] rounded-md p-4 max-w-md w-full shadow-lg border-l-4" {# –£–≤–µ–ª–∏—á–∏–ª z-index #}
    :class="{
        'bg-green-100 border-green-500 text-green-700': type === 'success',
        'bg-red-100 border-red-500 text-red-700': type === 'error',
        'bg-blue-100 border-blue-500 text-blue-700': type === 'info',
        'bg-yellow-100 border-yellow-500 text-yellow-700': type === 'warning',
    }"
    style="display: none;" x-cloak
>
    <p class="font-bold text-center" x-text="message"></p>
</div>


{# --- –û–ë–©–ò–ô –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –í–°–ï–• –ú–û–î–ê–õ–¨–ù–´–• –û–ö–û–ù --- #}
<div
    {# --- üëá –î–û–ë–ê–í–õ–ï–ù–´ isPreviewModalOpen –∏ previewUrl üëá --- #}
    x-data="{ isModalOpen: false, modalUrl: '', isDeleteModalOpen: false, deleteUrl: '', isPreviewModalOpen: false, previewUrl: '' }"

    {# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ Escape –¥–ª—è –í–°–ï–• –æ–∫–æ–Ω --- #}
    @keydown.escape.window="
        isModalOpen = false;
        isDeleteModalOpen = false;
        isPreviewModalOpen = false;
    "

    {# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π –æ—Ç HTMX –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–æ–Ω --- #}
    @htmx:after-swap.window="
        const triggerHeader = $event.detail.xhr.getResponseHeader('HX-Trigger');
        if (triggerHeader) {
            try {
                const triggers = JSON.parse(triggerHeader);
                if (triggers['close-modal']) {
                    isModalOpen = false;
                    htmx.find('#modal-content').innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
                }
                if (triggers['close-delete-modal']) {
                    isDeleteModalOpen = false;
                    htmx.find('#delete-modal-content').innerHTML = ''; // –û—á–∏—â–∞–µ–º
                }
                // –î–ª—è preview-–æ–∫–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ —Ç—Ä–∏–≥–≥–µ—Ä—É –ø–æ–∫–∞ –Ω–µ –Ω—É–∂–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º Escape/ClickAway
            } catch (e) {}
        }
    "

    {# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –û–¢–ö–†–´–¢–ò–Ø –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ --- #}
    @open-modal.window="
        isModalOpen = true; isDeleteModalOpen = false; isPreviewModalOpen = false; // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –æ–∫–Ω–∞
        modalUrl = $event.detail.url;
        $nextTick(() => {
             if (modalUrl) {
                htmx.ajax('GET', modalUrl, { target: '#modal-content' });
             }
        });
    "

    {# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –û–¢–ö–†–´–¢–ò–Ø –æ–∫–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è --- #}
    @open-delete-modal.window="
        isDeleteModalOpen = true; isModalOpen = false; isPreviewModalOpen = false; // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –æ–∫–Ω–∞
        deleteUrl = $event.detail.url;
         $nextTick(() => {
             if (deleteUrl) {
                htmx.ajax('GET', deleteUrl, { target: '#delete-modal-content' });
             }
        });
    "

    {# --- üëá –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–õ–Ø –û–¢–ö–†–´–¢–ò–Ø –û–ö–ù–ê –ü–†–ï–î–ü–†–û–°–ú–û–¢–†–ê üëá --- #}
    @open-preview-modal.window="
        isPreviewModalOpen = true; isModalOpen = false; isDeleteModalOpen = false; // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –æ–∫–Ω–∞
        previewUrl = $event.detail.url;
        $nextTick(() => {
             if (previewUrl) {
                // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–æ–≤–æ–≥–æ
                htmx.find('#preview-modal-content').innerHTML = '<div class=\'text-center p-8 text-white\'>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞...</div>';
                htmx.ajax('GET', previewUrl, { target: '#preview-modal-content' });
             }
        });
    "
    {# --- –ö–û–ù–ï–¶ –û–ë–†–ê–ë–û–¢–ß–ò–ö–ê --- #}
>

    {# --- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–æ—Å–Ω–æ–≤–Ω–æ–µ - –î–æ–±–∞–≤–∏—Ç—å/–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å) --- #}
    <div
    x-show="isModalOpen"
    x-transition.opacity
    class="fixed inset-0 z-50 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4" {# –û—Å—Ç–∞–≤–ª—è–µ–º flex –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è #}
    style="display: none;"
    x-cloak
>
    {# --- üëá –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ó–î–ï–°–¨ üëá --- #}
    {# –î–æ–±–∞–≤–ª—è–µ–º overflow-y-auto –∏ max-h-[90vh] #}
    <div id="modal-content-container"
         @click.away="isModalOpen = false"
         class="w-full max-w-5xl bg-transparent rounded-lg overflow-y-auto max-h-[90vh]"> {# –í—ã—Å–æ—Ç–∞ –Ω–µ –±–æ–ª–µ–µ 90% —ç–∫—Ä–∞–Ω–∞ #}
    {# --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô --- #}
        {# –°—é–¥–∞ HTMX –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å form_modal.html #}
        <div id="modal-content">
             <div class="text-center p-8 text-white">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>
</div>

    {# --- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è --- #}
    <div
        x-show="isDeleteModalOpen"
        x-transition.opacity
        class="fixed inset-0 z-50 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4"
        style="display: none;"
        x-cloak
    >
        {# –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ #}
        <div @click.away="isDeleteModalOpen = false" class="w-full max-w-md bg-transparent rounded-lg">
            {# –°—é–¥–∞ HTMX –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å confirm_delete.html #}
            <div id="delete-modal-content">
                <div class="text-center p-8 text-white">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    {# --- üëá –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –ü–†–ï–î–ü–†–û–°–ú–û–¢–†–ê üëá --- #}
    <div
        x-show="isPreviewModalOpen"
        x-transition.opacity
        class="fixed inset-0 z-50 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 overflow-y-auto" {# –î–æ–±–∞–≤–ª–µ–Ω overflow-y-auto #}
        style="display: none;"
        x-cloak
    >
        {# –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å @click.away (—É–∂–µ –≤–Ω—É—Ç—Ä–∏ preview_modal.html) #}
        {# –°—é–¥–∞ HTMX –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å preview_modal.html #}
        <div id="preview-modal-content" class="w-full max-w-2xl"> {# max-w-2xl –¥–ª—è —à–∏—Ä–∏–Ω—ã #}
            <div class="text-center p-8 text-white">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞...</div>
        </div>
    </div>
    {# --- –ö–û–ù–ï–¶ –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê –î–õ–Ø –ü–†–ï–î–ü–†–û–°–ú–û–¢–†–ê --- #}

</div> {# –ö–æ–Ω–µ—Ü –æ–±—â–µ–≥–æ div —Å x-data –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω #}


{# –í–ª–æ–∂–µ–Ω–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) #}
<div
    x-data="{ showNested: false, nestedUrl: '' }"
    x-show="showNested"
    @open-nested-modal.window="
        showNested = true;
        nestedUrl = $event.detail.url;
        $nextTick(() => {
            htmx.ajax('GET', nestedUrl, { target: '#nested-modal-content' });
        });
    "
    @close-nested-modal.window="showNested = false; htmx.find('#nested-modal-content').innerHTML = '';"
    @keydown.escape.window="showNested = false"
    x-transition.opacity
    class="fixed inset-0 z-60 bg-gray-900 bg-opacity-60 flex items-center justify-center p-4" {# –£–≤–µ–ª–∏—á–∏–ª z-index #}
    style="display: none;"
    x-cloak
>
    <div @click.away="showNested = false" class="w-full max-w-lg">
        <div id="nested-modal-content"></div>
    </div>
</div>
<script>
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏–∫–∏ —Ñ–æ—Ä–º—ã –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è Alpine.js
    function questionFormLogic(initialData) {
        return {
            options: initialData.options || [],
            minOptions: initialData.minOptions || 2,
            maxOptions: initialData.maxOptions || 5,

            initLogic() {
                // –ï—Å–ª–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –º–µ–Ω—å—à–µ –º–∏–Ω–∏–º—É–º–∞, –¥–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ
                while (this.options.filter(opt => !opt.DELETE).length < this.minOptions) {
                     this.addOption();
                }
            },

            addOption() {
                if (this.options.length < this.maxOptions) {
                    this.options.push({ text: '', option_image_url: null, is_correct: false, id: '', DELETE: false });
                }
            },

            removeOption(index) {
                const activeCount = this.options.filter(opt => !opt.DELETE).length;
                if (activeCount > this.minOptions) {
                    if (this.options[index].id) {
                         this.options[index].DELETE = true; // –ü–æ–º–µ—á–∞–µ–º –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
                    } else {
                         this.options.splice(index, 1); // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
                    }
                } else {
                    alert('–î–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º ' + this.minOptions + ' –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞.');
                }
            },

            setCorrect(selectedIndex) {
                this.options.forEach((option, index) => {
                    option.is_correct = (index === selectedIndex);
                });
            }
        }
    }
</script>
{% block scripts %}{% endblock %}

{# Script –¥–ª—è –ø–æ–∫–∞–∑–∞ Django messages —á–µ—Ä–µ–∑ Alpine.js #}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        {% if messages %}
            {% for message in messages %}
                window.dispatchEvent(new CustomEvent('show-message', {
                    detail: {
                        text: '{{ message|escapejs }}',
                        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–µ–≥–∏ Django –≤ —Ç–∏–ø—ã Alpine
                        type: '{% if message.tags == "debug" %}info{% elif message.tags == "error" %}error{% elif message.tags == "success" %}success{% elif message.tags == "warning" %}warning{% else %}info{% endif %}'
                    }
                }));
            {% endfor %}
        {% endif %}

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è htmx:beforeSend –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
        document.body.addEventListener('htmx:beforeSend', function(evt) {
            const indicator = document.getElementById('loading-indicator');
            if(indicator) indicator.style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        });
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è htmx:afterRequest –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
         document.body.addEventListener('htmx:afterRequest', function(evt) {
             const indicator = document.getElementById('loading-indicator');
             if(indicator) indicator.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
         });
    });
</script>

{% block styles %}{% endblock %}

</body>
</html>