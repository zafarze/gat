{% load static %}
<!DOCTYPE html>
<html lang="ru"
      x-data="{
        isSidebarOpen: false,
        sidebarCollapsed: localStorage.getItem('sidebarCollapsed') === 'true'
      }"
      x-watch="sidebarCollapsed, value => localStorage.setItem('sidebarCollapsed', value)"
>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}GAT Report{% endblock %}</title>

    <link rel="icon" href="{% static 'img/favicon.ico' %}" type="image/x-icon">

    <link href="{% static 'css/style.css' %}" rel="stylesheet">

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://unpkg.com/htmx.org@1.9.10"></script>

    <style>
        [x-cloak] { display: none !important; }
    </style>

    {% block head %}{% endblock %}
</head>

<body class="font-sans" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>

<div class="flex h-screen bg-gray-100"
     @force-refresh.window="setTimeout(() => window.location.reload(), 2000)"
>

    {# Mobile Sidebar #}
    <div class="lg:hidden">
        {# Overlay #}
        <div x-show="isSidebarOpen"
             x-transition:enter="transition-opacity ease-linear duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition-opacity ease-linear duration-300"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             @click="isSidebarOpen = false"
             class="fixed inset-0 bg-gray-600 bg-opacity-75 z-30" x-cloak>
        </div>

        {# Sidebar Panel #}
        <div x-show="isSidebarOpen"
             class="fixed inset-y-0 left-0 flex-shrink-0 z-40" x-cloak>
             {# ✨ ИЗМЕНЕНИЕ ЗДЕСЬ: Удален класс `max-w-xs` ✨ #}
            <div class="relative flex-1 flex flex-col w-full bg-gray-800"
                 x-transition:enter="transition ease-in-out duration-300 transform"
                 x-transition:enter-start="-translate-x-full"
                 x-transition:enter-end="translate-x-0"
                 x-transition:leave="transition ease-in-out duration-300 transform"
                 x-transition:leave-start="translate-x-0"
                 x-transition:leave-end="-translate-x-full">

                {# Close button #}
                <div class="absolute top-0 right-0 -mr-12 pt-2">
                    <button @click="isSidebarOpen = false" type="button" class="ml-1 flex items-center justify-center h-10 w-10 rounded-full focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white">
                        <svg class="h-6 w-6 text-white" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                {# Sidebar Content #}
                {% include 'components/sidebar.html' %}
            </div>
        </div>
    </div>

    {# Desktop Sidebar #}
    <div class="hidden lg:flex lg:flex-shrink-0">
        <div class="flex flex-col transition-all duration-300" :class="{'w-64': !sidebarCollapsed, 'w-20': sidebarCollapsed}">
            {% include 'components/sidebar.html' %}
        </div>
    </div>

    {# Main content area #}
    <div class="flex flex-col w-0 flex-1 overflow-hidden">
        {% include 'components/header.html' %}
        <main class="flex-1 relative overflow-y-auto focus:outline-none">
            <div class="py-6 px-4 sm:px-6 lg:px-8">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>
</div>

{# Global Notifier (без изменений) #}
<div
    x-data="{ show: false, message: '', type: 'success' }"
    @htmx:after-swap.window="
        const trigger = $event.detail.xhr.getResponseHeader('HX-Trigger');
        if (trigger) {
            try {
                const data = JSON.parse(trigger);
                if (data['show-message']) {
                    $dispatch('show-message', data['show-message']);
                }
            } catch (e) {}
        }
    "
    @show-message.window="
        message = $event.detail.text;
        type = $event.detail.type;
        show = true;
        setTimeout(() => show = false, 8000);
    "
    x-show="show"
    x-transition
    class="fixed top-5 left-1/2 -translate-x-1/2 z-50 rounded-lg p-4 max-w-md w-full border-l-4"
    :class="{
        'bg-green-100 border-green-500 text-green-700': type === 'success',
        'bg-red-100 border-red-500 text-red-700': type === 'error',
        'bg-blue-100 border-blue-500 text-blue-700': type === 'info',
        'bg-yellow-100 border-yellow-500 text-yellow-700': type === 'warning',
    }"
    style="display: none;" x-cloak
>
    <p class="font-bold text-center" x-text="message"></p>
</div>

{# Nested Modal (без изменений) #}
<div
    x-data="{ showNested: false, nestedUrl: '' }"
    x-show="showNested"
    @open-nested-modal.window="
        showNested = true;
        nestedUrl = $event.detail.url;
        $nextTick(() => {
            htmx.ajax('GET', nestedUrl, { target: '#nested-modal-content' });
        });
    "
    @close-nested-modal.window="showNested = false; htmx.find('#nested-modal-content').innerHTML = '';"
    @keydown.escape.window="showNested = false"
    x-transition.opacity
    class="fixed inset-0 z-60 bg-gray-900 bg-opacity-60 flex items-center justify-center p-4"
    style="display: none;"
    x-cloak
>
    <div @click.away="showNested = false" class="w-full max-w-lg">
        <div id="nested-modal-content"></div>
    </div>
</div>

{% block scripts %}{% endblock %}

{# Script для показа Django messages (без изменений) #}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        {% if messages %}
            {% for message in messages %}
                window.dispatchEvent(new CustomEvent('show-message', {
                    detail: {
                        text: '{{ message|escapejs }}',
                        type: '{{ message.tags }}'
                    }
                }));
            {% endfor %}
        {% endif %}
    });
</script>

</body>
</html>