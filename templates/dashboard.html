{% extends 'base.html' %}
{% load static %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è - –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è{% endblock %}

{% block content %}
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
        <h1 class="text-3xl font-bold text-gray-800">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
        {# --- –ë–õ–û–ö –° –§–ò–õ–¨–¢–†–ê–ú–ò –ü–ï–†–ò–û–î–û–í --- #}
        <div class="flex items-center bg-white rounded-lg shadow-sm p-1 space-x-1">
            <a href="{% url 'core:dashboard' %}?period=quarter" class="px-4 py-2 text-sm font-medium rounded-md transition-colors {% if selected_period == 'quarter' %}bg-indigo-600 text-white shadow{% else %}text-gray-600 hover:bg-gray-100{% endif %}">–≠—Ç–∞ —á–µ—Ç–≤–µ—Ä—Ç—å</a>
            <a href="{% url 'core:dashboard' %}?period=year" class="px-4 py-2 text-sm font-medium rounded-md transition-colors {% if selected_period == 'year' %}bg-indigo-600 text-white shadow{% else %}text-gray-600 hover:bg-gray-100{% endif %}">–≠—Ç–æ—Ç –≥–æ–¥</a>
            <a href="{% url 'core:dashboard' %}?period=all" class="px-4 py-2 text-sm font-medium rounded-md transition-colors {% if selected_period == 'all' %}bg-indigo-600 text-white shadow{% else %}text-gray-600 hover:bg-gray-100{% endif %}">–í—Å–µ –≤—Ä–µ–º—è</a>
        </div>
    </div>

    {# --- –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ë–õ–û–ö–ê –û–ü–û–í–ï–©–ï–ù–ò–Ø --- #}
    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md shadow-sm mb-6" role="alert">
      <div class="flex items-center">
        <div class="py-1">
          <svg class="fill-current h-6 w-6 text-yellow-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zm12.73-1.41A8 8 0 1 0 4.34 4.34a8 8 0 0 0 11.32 11.32zM9 11V9h2v6H9v-4zm0-6h2v2H9V5z"/></svg>
        </div>
        <div>
          <p class="font-bold">–í–Ω–∏–º–∞–Ω–∏–µ: –ë–µ—Ç–∞-–≤–µ—Ä—Å–∏—è!</p>
          <p class="text-sm">–≠—Ç–æ—Ç –ø–æ—Ä—Ç–∞–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å—Ç–∞–¥–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏. –ï—Å–ª–∏ –≤—ã –æ–±–Ω–∞—Ä—É–∂–∏—Ç–µ –æ—à–∏–±–∫–∏ –∏–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —É–ª—É—á—à–µ–Ω–∏—é, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–æ–±—â–∏—Ç–µ –º–Ω–µ –≤ Telegram:
            <a href="https://t.me/+992918202223" target="_blank" class="font-medium underline hover:text-yellow-800">
              +992 918 20 22 23
            </a>.
            –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∏ –ø–æ–º–æ—â—å! üôè
          </p>
        </div>
      </div>
    </div>
    {# --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê –û–ü–û–í–ï–©–ï–ù–ò–Ø --- #}

    {# --- –ù–ê–ß–ê–õ–û –ë–õ–û–ö–ê –° –ö–ê–†–¢–û–ß–ö–ê–ú–ò KPI --- #}
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">

        {# --- –ö–∞—Ä—Ç–æ—á–∫–∞ –®–∫–æ–ª—ã --- #}
        {# ‚ú® WRAPPER: –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ —Å—Å—ã–ª–∫—É #}
        <a href="{% url 'core:school_list' %}" class="block bg-white p-5 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">–í—Å–µ–≥–æ —à–∫–æ–ª</p>
                    <p class="text-3xl font-bold text-gray-800">{{ school_count }}</p>
                </div>
                <div class="bg-blue-100 rounded-full p-3">
                    <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                </div>
            </div>
        </a> {# ‚ú® END WRAPPER #}

        {# --- –ö–∞—Ä—Ç–æ—á–∫–∞ –°—Ç—É–¥–µ–Ω—Ç—ã --- #}
        {# ‚ú® WRAPPER: –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ —Å—Å—ã–ª–∫—É #}
        <a href="{% url 'core:student_school_list' %}" class="block bg-white p-5 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">–í—Å–µ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</p>
                    <p class="text-3xl font-bold text-gray-800">{{ student_count }}</p>
                </div>
                <div class="bg-purple-100 rounded-full p-3">
                    <svg class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                </div>
            </div>
        </a> {# ‚ú® END WRAPPER #}

        {# --- –ö–∞—Ä—Ç–æ—á–∫–∞ –ü—Ä–µ–¥–º–µ—Ç—ã --- #}
        {# ‚ú® WRAPPER: –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ —Å—Å—ã–ª–∫—É #}
        <a href="{% url 'core:subject_list' %}" class="block bg-white p-5 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">–í—Å–µ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</p>
                    <p class="text-3xl font-bold text-gray-800">{{ subject_count }}</p>
                </div>
                <div class="bg-green-100 rounded-full p-3">
                    <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                </div>
            </div>
        </a> {# ‚ú® END WRAPPER #}

        {# --- –ö–∞—Ä—Ç–æ—á–∫–∞ –¢–µ—Å—Ç—ã --- #}
        {# ‚ú® WRAPPER: –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ —Å—Å—ã–ª–∫—É #}
        <a href="{% url 'core:gat_test_list' %}" class="block bg-white p-5 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">–ü—Ä–æ–≤–µ–¥–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤</p>
                    <p class="text-3xl font-bold text-gray-800">{{ test_count }}</p>
                </div>
                <div class="bg-yellow-100 rounded-full p-3">
                    <svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
                </div>
            </div>
        </a> {# ‚ú® END WRAPPER #}

    </div>


    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        {# --- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê –° –ì–†–ê–§–ò–ö–ê–ú–ò --- #}
        <div class="lg:col-span-2 space-y-8">

            <div class="grid grid-cols-1 xl:grid-cols-5 gap-8">
                <div class="xl:col-span-2 bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏</h2>
                    <div class="relative h-64">
                        <canvas id="performanceDistributionChart"></canvas>
                    </div>
                </div>
                <div class="xl:col-span-3 bg-white p-6 rounded-lg shadow-md">
                    {% if user.is_staff or user.profile.role == 'EXPERT' %}
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">–¢–æ–ø-10 —à–∫–æ–ª –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É –±–∞–ª–ª—É</h2>
                    {% else %}
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">–£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å –∫–ª–∞—Å—Å–æ–≤</h2>
                    {% endif %}
                    <div class="relative h-64">
                        <canvas id="schoolChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">–¢–æ–ø-10 –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É –±–∞–ª–ª—É (%)</h2>
                <div class="relative h-96">
                    <canvas id="subjectChart"></canvas>
                </div>
            </div>
        </div>

        {# --- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê –°–û –°–ü–ò–°–ö–ê–ú–ò --- #}
        <div class="space-y-8">

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                    –ù–µ–¥–∞–≤–Ω–∏–µ —Ç–µ—Å—Ç—ã
                </h2>
                <ul class="space-y-3">
                    {% for test in recent_tests %}
                    <li class="p-2 rounded-md hover:bg-gray-50">
                        <a href="{% url 'core:detailed_results_list' test.test_number %}?test_id={{ test.id }}" class="block">
                            <p class="font-medium text-gray-800 text-sm">{{ test.name }}</p>
                            <p class="text-xs text-gray-500">{{ test.school.name }} / {% if test.school_class %}{{ test.school_class.name }}{% endif %} - {{ test.test_date|date:"d.m.Y" }}</p>
                        </a>
                    </li>
                    {% empty %}
                    <li class="text-center text-gray-500 p-4">–ù–µ—Ç –Ω–µ–¥–∞–≤–Ω–∏—Ö —Ç–µ—Å—Ç–æ–≤.</li>
                    {% endfor %}
                </ul>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    <svg class="h-6 w-6 text-green-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                    –õ–∏–¥–µ—Ä—ã —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏
                </h2>
                <ul class="space-y-3">
                    {% for item in top_students %}
                    <li class="flex items-center justify-between p-2 rounded-md hover:bg-gray-50">
                        <a href="{% url 'core:student_progress' item.student.id %}" class="flex items-center space-x-3">
                            <div class="bg-green-100 text-green-600 font-bold rounded-full h-8 w-8 flex items-center justify-center text-sm">{{ forloop.counter }}</div>
                            <div>
                                <p class="font-medium text-gray-800 text-sm">{{ item.student }}</p>
                                <p class="text-xs text-gray-500">{{ item.student.school_class }}</p>
                            </div>
                        </a>
                        <span class="font-bold text-green-600">{{ item.avg_score }}</span>
                    </li>
                    {% empty %}
                    <li class="text-center text-gray-500 p-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</li>
                    {% endfor %}
                </ul>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    <svg class="h-6 w-6 text-red-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" /></svg>
                    –í –∑–æ–Ω–µ –≤–Ω–∏–º–∞–Ω–∏—è
                </h2>
                <ul class="space-y-3">
                    {% for item in worst_students %}
                    <li class="flex items-center justify-between p-2 rounded-md hover:bg-gray-50">
                        <a href="{% url 'core:student_progress' item.student.id %}" class="flex items-center space-x-3">
                             <div class="bg-red-100 text-red-600 font-bold rounded-full h-8 w-8 flex items-center justify-center text-sm">{{ forloop.revcounter }}</div>
                             <div>
                                <p class="font-medium text-gray-800 text-sm">{{ item.student }}</p>
                                <p class="text-xs text-gray-500">{{ item.student.school_class }}</p>
                            </div>
                        </a>
                        <span class="font-bold text-red-600">{{ item.avg_score }}</span>
                    </li>
                     {% empty %}
                    <li class="text-center text-gray-500 p-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
{% endblock %}


{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>


<script>
document.addEventListener('DOMContentLoaded', () => {
    Chart.register(ChartDataLabels);
    Chart.defaults.plugins.datalabels.display = false; // –û—Ç–∫–ª—é—á–∞–µ–º –º–µ—Ç–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

    const datalabelsConfig = {
        display: true,
        anchor: 'end', align: 'end', color: '#4b5563',
        font: { weight: 'bold', size: 12 },
        formatter: (value) => Math.round(value),
    };

    // –ì—Ä–∞—Ñ–∏–∫ –®–∫–æ–ª / –ö–ª–∞—Å—Å–æ–≤
    const schoolChartLabels = {{ school_chart_labels|safe }};
    if (schoolChartLabels && schoolChartLabels.length > 0) {
        const schoolCtx = document.getElementById('schoolChart').getContext('2d');
        new Chart(schoolCtx, {
            type: 'bar',
            data: {
                labels: schoolChartLabels,
                datasets: [{
                    label: '–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª',
                    data: {{ school_chart_data|safe }},
                    backgroundColor: 'rgba(79, 70, 229, 0.7)',
                    borderColor: 'rgba(79, 70, 229, 1)',
                    borderWidth: 1,
                    borderRadius: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, datalabels: datalabelsConfig },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // –ì—Ä–∞—Ñ–∏–∫ –ü—Ä–µ–¥–º–µ—Ç–æ–≤
    const subjectChartLabels = {{ subject_chart_labels|safe }};
    if (subjectChartLabels && subjectChartLabels.length > 0) {
        const subjectCtx = document.getElementById('subjectChart').getContext('2d');
        new Chart(subjectCtx, {
            type: 'bar',
            data: {
                labels: subjectChartLabels,
                datasets: [{
                    label: '–°—Ä–µ–¥–Ω–∏–π % –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è',
                    data: {{ subject_chart_data|safe }},
                    backgroundColor: 'rgba(5, 150, 105, 0.7)',
                    borderColor: 'rgba(5, 150, 105, 1)',
                    borderWidth: 1,
                    borderRadius: 4,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, datalabels: datalabelsConfig },
                scales: { x: { beginAtZero: true, max: 100 } }
            }
        });
    }

    // –ì—Ä–∞—Ñ–∏–∫ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏
    const distributionData = {{ distribution_chart_data|safe }};
    if (distributionData && distributionData.some(v => v > 0)) {
        const distCtx = document.getElementById('performanceDistributionChart').getContext('2d');
        new Chart(distCtx, {
            type: 'doughnut',
            data: {
                labels: {{ distribution_chart_labels|safe }},
                datasets: [{
                    data: distributionData,
                    backgroundColor: ['#22c55e', '#84cc16', '#facc15', '#ef4444'],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { padding: 15, boxWidth: 12 } },
                    datalabels: {
                        display: true,
                        color: '#fff',
                        font: { weight: 'bold' },
                        formatter: (value, ctx) => {
                            let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            let percentage = (value * 100 / sum);
                            return percentage > 5 ? percentage.toFixed(0) + '%' : '';
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}