{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold text-gray-800 mb-6">{{ title }}</h1>

{# --- БЛОК С ФИЛЬТРАМИ --- #}
<div class="bg-white p-6 rounded-lg shadow mb-8">
    <form method="get">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div>{{ form.quarter.label_tag }} {{ form.quarter }}</div>
            <div>{{ form.test_number.label_tag }} {{ form.test_number }}</div>
            <div>{{ form.schools.label_tag }} {{ form.schools }}</div>
            <div>{{ form.school_classes.label_tag }} {{ form.school_classes }}</div>
            <div class="lg:col-span-2">{{ form.subjects.label_tag }} {{ form.subjects }}</div>
        </div>
        <div class="mt-6 flex justify-end">
            <button type="submit" class="bg-indigo-600 text-white px-8 py-3 rounded-lg hover:bg-indigo-700 font-bold">Сравнить</button>
        </div>
    </form>
</div>

{% if has_results %}
    {# --- БЛОК С ГРАФИКОМ --- #}
    <div class="bg-white p-6 rounded-lg shadow mb-8">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Общая успеваемость по школам и предметам (% правильных ответов)</h2>
        <canvas id="summaryChart"></canvas>
    </div>

    {# --- БЛОК С ДЕТАЛЬНОЙ ТАБЛИЦЕЙ --- #}
    <div class="bg-white shadow-md rounded-lg overflow-x-auto">
        <h2 class="text-xl font-bold text-gray-800 p-6">Детальный анализ по вопросам</h2>
        <table class="min-w-full divide-y divide-gray-200 border-t">
            <thead class="bg-gray-50">
                <tr>
                    <th rowspan="2" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase border-r align-middle">Предмет</th>
                    <th rowspan="2" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase border-r align-middle">Вопрос №</th>
                    {% for school_id, data in analysis_data.items %}
                        <th colspan="2" class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase border-r">{{ data.school_name }}</th>
                    {% endfor %}
                </tr>
                <tr>
                    {% for school_id, data in analysis_data.items %}
                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 border-l">% Верно</th>
                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 border-r">Кол-во</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for subject_name in unique_subject_names %}
                    {% if first_school_data %}
                        {% with question_details_dict=first_school_data.subjects|get_item:subject_name|get_item:'question_details' %}
                            {% for q_num, q_data in question_details_dict.items %}
                            <tr class="hover:bg-gray-50">
                                {% if forloop.first %}
                                    <td rowspan="{% if question_details_dict|length > 0 %}{{ question_details_dict|length }}{% else %}1{% endif %}" class="px-4 py-4 font-medium border-r align-top">{{ subject_name }}</td>
                                {% endif %}
                                <td class="px-4 py-4 text-center border-r">{{ q_num }}</td>
                                {% for school_id, school_data in analysis_data.items %}
                                    {% with question_stats=school_data.subjects|get_item:subject_name|get_item:'question_details'|get_item:q_num %}
                                        {% if question_stats %}
                                            <td class="px-2 py-4 text-center border-l {% if question_stats.percentage >= 80 %}bg-green-50{% elif question_stats.percentage < 40 %}bg-red-50{% endif %}">
                                                {{ question_stats.percentage }}%
                                            </td>
                                            <td class="px-2 py-4 text-center text-xs text-gray-500 border-r">
                                                {{ question_stats.correct }}/{{ question_stats.total }}
                                            </td>
                                        {% else %}
                                            <td class="px-2 py-4 text-center text-gray-400 border-l">—</td>
                                            <td class="px-2 py-4 text-center text-xs text-gray-400 border-r">0/0</td>
                                        {% endif %}
                                    {% endwith %}
                                {% endfor %}
                            </tr>
                            {% empty %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-4 font-medium border-r align-top">{{ subject_name }}</td>
                                    <td class="px-4 py-4 text-center border-r">-</td>
                                    {% for school_id, school_data in analysis_data.items %}
                                        <td class="px-2 py-4 text-center text-gray-400 border-l">—</td>
                                        <td class="px-2 py-4 text-center text-xs text-gray-400 border-r">0/0</td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        {% endwith %}
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
{% elif request.GET %}
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg shadow">
        <p class="text-yellow-800">Нет данных для отображения. Пожалуйста, выберите другие фильтры и нажмите "Сравнить".</p>
    </div>
{% endif %}


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- КОД ДЛЯ ГРАФИКА ---
        {% if has_results and chart_data %}
            try {
                const ctx = document.getElementById('summaryChart').getContext('2d');
                const chartDataFromServer = JSON.parse('{{ chart_data|safe }}');
                const getRandomColor = () => {
                    const r = Math.floor(Math.random() * 200);
                    const g = Math.floor(Math.random() * 200);
                    const b = Math.floor(Math.random() * 200);
                    return `rgba(${r}, ${g}, ${b}, 0.6)`;
                };
                chartDataFromServer.datasets.forEach(dataset => {
                    const color = getRandomColor();
                    dataset.backgroundColor = color;
                    dataset.borderColor = color.replace('0.6', '1');
                    dataset.borderWidth = 1;
                });
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartDataFromServer.labels,
                        datasets: chartDataFromServer.datasets
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'top', }, title: { display: false, } },
                        scales: { y: { beginAtZero: true, max: 100, ticks: { callback: function(value) { return value + '%' } } } }
                    }
                });
            } catch (e) {
                console.error("Ошибка при отрисовке графика:", e);
            }
        {% endif %}

        // --- КОД ДЛЯ ДИНАМИЧЕСКИХ ФИЛЬТРОВ ---
        const schoolsSelect = document.getElementById('id_schools');
        const classesSelect = document.getElementById('id_school_classes');
        const subjectsSelect = document.getElementById('id_subjects');
    
        schoolsSelect.addEventListener('change', function () {
            const selectedSchoolIds = Array.from(schoolsSelect.selectedOptions).map(option => option.value);
            classesSelect.innerHTML = '<option>Загрузка...</option>';
            subjectsSelect.innerHTML = '<option>Загрузка...</option>';
            if (selectedSchoolIds.length === 0) {
                classesSelect.innerHTML = '';
                subjectsSelect.innerHTML = '';
                return;
            }
            const url = `{% url 'api_load_subjects_and_classes' %}?${selectedSchoolIds.map(id => `school_ids[]=${id}`).join('&')}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    classesSelect.innerHTML = '';
                    data.classes.forEach(c => {
                        const option = new Option(c.name, c.id);
                        classesSelect.add(option);
                    });
                    subjectsSelect.innerHTML = '';
                    data.subjects.forEach(s => {
                        const option = new Option(s.name, s.id);
                        subjectsSelect.add(option);
                    });
                });
        });
    });
</script>

{% endblock %}