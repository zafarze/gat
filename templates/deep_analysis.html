{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/deep_analysis.css' %}">
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-4xl font-bold mb-2 gradient-text">{{ title }}</h1>
    <p class="text-lg text-gray-600 mb-8">Анализ успеваемости и образовательной динамики</p>

    {# --- ФОРМА ФИЛЬТРОВ --- #}
    <div class="glass-card p-6 rounded-lg mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Фильтры</h2>
        <form method="get" id="deep-analysis-form">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="filter-card" data-filter="quarters">
                    <label class="font-bold text-gray-700 text-lg">{{ form.quarters.label }}</label>
                    <div class="chip-container items-center">
                        {% for choice in form.quarters %}<label class="chip">{{ choice.tag }}<span>{{ choice.choice_label }}</span></label>{% endfor %}
                    </div>
                </div>
                <div class="filter-card" data-filter="schools">
                    <label class="font-bold text-gray-700 text-lg">{{ form.schools.label }}</label>
                    <div class="chip-container items-center">
                        {% for choice in form.schools %}<label class="chip">{{ choice.tag }}<span>{{ choice.choice_label }}</span></label>{% endfor %}
                    </div>
                </div>
                <div class="filter-card" id="classes-filter-card" data-filter="school_classes">
                    <label class="font-bold text-gray-700 text-lg">{{ form.school_classes.label }}</label>
                    <div id="classes-chip-container" class="chip-container items-center">
                        {% if grouped_classes %}
                            {% for group_name, classes_in_group in grouped_classes.items %}
                                <div class="w-full">
                                    <p class="font-semibold text-gray-600 text-sm mt-2 mb-1">{{ group_name }}</p>
                                    {% for choice in classes_in_group %}
                                        {% with choice_id_str=choice.id|stringformat:"s" %}
                                        <label class="chip">
                                            <input type="checkbox" name="school_classes" value="{{ choice.id }}" {% if choice_id_str in selected_class_ids %}checked{% endif %}>
                                            <span>{{ choice.name }}</span>
                                        </label>
                                        {% endwith %}
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-sm text-gray-500">Сначала выберите школу.</p>
                        {% endif %}
                    </div>
                </div>
                <div class="filter-card" data-filter="test_numbers">
                    <label class="font-bold text-gray-700 text-lg">{{ form.test_numbers.label }}</label>
                    <div class="chip-container items-center">
                        {% for choice in form.test_numbers %}<label class="chip">{{ choice.tag }}<span>{{ choice.choice_label }}</span></label>{% endfor %}
                    </div>
                </div>
                <div class="filter-card" data-filter="days">
                    <label class="font-bold text-gray-700 text-lg">{{ form.days.label }}</label>
                    <div class="chip-container items-center">
                        {% for choice in form.days %}<label class="chip">{{ choice.tag }}<span>{{ choice.choice_label }}</span></label>{% endfor %}
                    </div>
                </div>
                <div class="filter-card" data-filter="subjects">
                    <label class="font-bold text-gray-700 text-lg">{{ form.subjects.label }}</label>
                    <div id="subjects-chip-container" class="chip-container items-center">
                        <p class="text-sm text-gray-500">...</p>
                    </div>
                </div>
            </div>
            <div class="mt-8 border-t pt-6 flex justify-end">
                <button type="submit" class="btn btn-primary px-10 py-3 text-lg">Применить</button>
            </div>
        </form>
    </div>

    {% if has_results %}
    <div class="glass-card p-6 rounded-2xl">
        <div class="tabs">
            <button class="tab-button active" data-tab="summary">Сводка</button>
            <button class="tab-button" data-tab="heatmap">Анализ по вопросам</button>
            {% if trend_chart_data %}<button class="tab-button" data-tab="trends">Динамика</button>{% endif %}
            <button class="tab-button" data-tab="insights">Инсайты</button>
        </div>

        <div id="summary" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                {# --- ✨ ИЗМЕНЕНИЕ: Этот график теперь использует 'comparison_chart_data' и называется "Сравнение успеваемости" --- #}
                <div class="bg-white p-6 rounded-2xl shadow-md">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Сравнение успеваемости</h3>
                    <canvas id="comparisonChart" data-chart-data='{{ comparison_chart_data|safe }}'></canvas>
                </div>
                {# --- ✨ ИЗМЕНЕНИЕ: Этот график теперь использует 'summary_chart_data' и отображает только средние значения --- #}
                <div class="bg-white p-6 rounded-2xl shadow-md">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Средний балл по предметам</h3>
                    <canvas id="overallPerformanceChart" data-chart-data='{{ summary_chart_data|safe }}'></canvas>
                </div>
            </div>
        </div>

        <div id="heatmap" class="tab-content">
            {% for subject, data in heatmap_data.items %}
                <div class="mb-10 bg-white p-6 rounded-2xl shadow-md">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">{{ subject }}</h3>
                    <div class="overflow-x-auto rounded-xl shadow-sm"><table class="heatmap-table"><thead><tr><th class="rounded-tl-xl">Школа/Вопрос</th>{% for q_num in data.questions %}<th>{{ q_num }}</th>{% endfor %}</tr></thead><tbody>{% for school_name, questions_data in data.schools.items %}<tr><td class="font-semibold text-left p-3 bg-gray-50">{{ school_name }}</td>{% for q_num in data.questions %}{% with cell_data=questions_data|get_item:q_num|default:None %}<td title="Правильно: {{ cell_data.correct }}/{{ cell_data.total }} ({{ cell_data.percentage }}%)" style="background-color: {% with p_val=cell_data.percentage|default:-1 %}{% if p_val >= 80 %}#dcfce7{% elif p_val >= 50 %}#fef9c3{% elif p_val >= 0 %}#fee2e2{% else %}#f3f4f6{% endif %}{% endwith %}; padding: 0.5rem;">{% if cell_data is not None %}<div class="flex flex-col items-center leading-tight"><span class="font-bold text-base">{{ cell_data.percentage }}%</span><span class="text-xs text-gray-500 mt-1">{{ cell_data.correct }}/{{ cell_data.total }}</span></div>{% else %}—{% endif %}</td>{% endwith %}{% endfor %}</tr>{% endfor %}</tbody></table></div>
                    {% with summary=heatmap_summary|get_item:subject %}{% if summary %}<div class="mt-6 p-4 bg-gray-50 rounded-lg border"><h4 class="font-bold text-lg mb-3 text-gray-700">Итоги по предмету: {{ subject }}</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h5 class="font-semibold mb-2">Рейтинг:</h5><ul class="space-y-2">{% for school_stat in summary.ranking %}<li class="flex justify-between items-center p-2 rounded-md {% if forloop.first %}bg-green-100 border border-green-200{% elif forloop.last and summary.ranking|length > 1 %}bg-red-100 border border-red-200{% else %}bg-gray-100{% endif %}"><span><span class="font-bold mr-2">{{ forloop.counter }}.</span>{{ school_stat.school }}</span><span class="font-bold text-lg">{{ school_stat.avg }}%</span></li>{% endfor %}</ul></div>{% if summary.ranking %}<div><h5 class="font-semibold mb-2">Ключевые выводы:</h5><ul class="list-disc list-inside space-y-2 text-gray-600"><li>Средний процент по всем: <strong class="text-gray-800">{{ summary.overall_avg }}%</strong>.</li>{% if summary.ranking|length > 1 %}{% with leader=summary.ranking.0 outsider=summary.ranking|last %}<li>Лидер <strong class="text-green-600">{{ leader.school }}</strong> опережает <strong class="text-red-600">{{ outsider.school }}</strong> на <strong class="text-indigo-600">{{ summary.difference }}%</strong>.</li>{% endwith %}{% endif %}{% if summary.easiest %}<li>Самый легкий вопрос: <strong>№{{ summary.easiest.0.q_num }}</strong> ({{ summary.easiest.0.percentage }}% верных ответов).</li>{% endif %}{% if summary.hardest %}<li>Самый сложный вопрос: <strong>№{{ summary.hardest.0.q_num }}</strong> ({{ summary.hardest.0.percentage }}% верных ответов).</li>{% endif %}</ul></div>{% endif %}</div></div>{% endif %}{% endwith %}
                </div>
            {% endfor %}
        </div>

        {% if trend_chart_data %}<div id="trends" class="tab-content"><div class="bg-white p-6 rounded-2xl shadow-md"><h3 class="text-xl font-bold text-gray-800 mb-4">Динамика успеваемости по четвертям</h3><canvas id="trendChart" data-chart-data='{{ trend_chart_data|safe }}'></canvas></div></div>{% endif %}

        <div id="insights" class="tab-content"><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div class="insight-card"><h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>Топ-3 самых сложных вопроса</h3>{% for subject, questions in problematic_questions.items %}<div class="mb-4"><h4 class="font-semibold text-md text-gray-700 mb-2">{{ subject }}</h4><ul class="space-y-2">{% for q in questions %}<li class="flex justify-between items-center p-2 bg-red-50 rounded-lg"><span class="font-medium">Вопрос №{{ q.q }}</span><span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-sm font-bold">{{ q.p }}%</span><span class="text-gray-500 text-sm">{{ q.school }}</span></li>{% endfor %}</ul></div>{% empty %}<p class="text-gray-500">Не удалось определить проблемные вопросы.</p>{% endfor %}</div><div class="insight-card"><h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Ученики в группе риска (&lt;40%)</h3>{% if at_risk_students %}<div class="space-y-3 max-h-96 overflow-y-auto pr-2">{% for student in at_risk_students %}<div class="risk-student-card"><div class="flex justify-between items-center mb-1"><span class="font-bold text-gray-800">{{ student.name }}</span><span class="text-red-600 font-bold text-lg">{{ student.score }}%</span></div><div class="text-sm text-gray-500"><span>{{ student.school }}</span>, <span class="font-medium text-gray-600">{{ student.class }}</span> <span>- Предмет: <strong class="text-indigo-600">{{ student.subject }}</strong></span></div></div>{% endfor %}</div>{% else %}<div class="bg-green-50 p-4 rounded-lg text-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-green-500 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="text-green-700 font-medium">Ученики в группе риска не найдены. Отличная работа!</p></div>{% endif %}</div></div></div>
    </div>
    {% elif request.GET %}
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-2xl shadow-md flex items-start gap-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-600 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg><div><h3 class="font-bold text-yellow-800">Данные не найдены</h3><p class="text-yellow-700">Нет данных для отображения. Пожалуйста, выберите другие фильтры.</p></div></div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    Chart.register(ChartDataLabels);

    // --- ЛОГИКА ДЛЯ ФИЛЬТРОВ (без изменений) ---
    const form = document.getElementById('deep-analysis-form');
    if (form) {
        const schoolsCard = form.querySelector('[data-filter="schools"]');
        const classesCard = form.querySelector('[data-filter="school_classes"]');
        const testsCard = form.querySelector('[data-filter="test_numbers"]');
        const daysCard = form.querySelector('[data-filter="days"]');
        const classesContainer = document.getElementById('classes-chip-container');
        const subjectsContainer = document.getElementById('subjects-chip-container');
        const classesApiUrl = "{% url 'core:api_load_classes_as_chips' %}";
        const subjectsApiUrl = "{% url 'core:api_load_subjects_for_filters' %}";
        const selectedClassIds = {{ selected_class_ids_json|safe }}.map(String);
        const selectedSubjectIds = {{ selected_subject_ids_json|safe }}.map(String);

        function getSelectedValues(card) {
            if (!card) return [];
            return Array.from(card.querySelectorAll('input:checked')).map(cb => cb.value);
        }

        const loadClasses = () => {
            const school_ids = getSelectedValues(schoolsCard);
            if (school_ids.length === 0) {
                classesContainer.innerHTML = '<p class="text-sm text-gray-500">Сначала выберите школу.</p>';
                loadSubjects(); return;
            }
            const params = new URLSearchParams();
            school_ids.forEach(id => params.append('schools', id));
            selectedClassIds.forEach(id => params.append('school_classes', id));
            fetch(`${classesApiUrl}?${params.toString()}`).then(r => r.text()).then(html => {
                classesContainer.innerHTML = html; loadSubjects();
            }).catch(e => { console.error(e); classesContainer.innerHTML = '<p class="text-sm text-red-500">Ошибка.</p>'; loadSubjects(); });
        };

        const loadSubjects = () => {
            const school_ids = getSelectedValues(schoolsCard);
            let class_ids = getSelectedValues(classesCard);
            if (class_ids.length === 0 && classesContainer.querySelector('input[name="school_classes"]')) {
                class_ids = Array.from(classesContainer.querySelectorAll('input[name="school_classes"]')).map(inp => inp.value);
            }
            const test_numbers = getSelectedValues(testsCard);
            const days = getSelectedValues(daysCard);
            if (school_ids.length === 0 || class_ids.length === 0 || test_numbers.length === 0) {
                subjectsContainer.innerHTML = '<p class="text-sm text-gray-500">Выберите школу, класс и тест.</p>'; return;
            }
            const params = new URLSearchParams();
            school_ids.forEach(id => params.append('school_ids[]', id));
            class_ids.forEach(id => params.append('class_ids[]', id));
            test_numbers.forEach(id => params.append('test_numbers[]', id));
            days.forEach(id => params.append('days[]', id));
            fetch(`${subjectsApiUrl}?${params.toString()}`).then(r => r.json()).then(data => {
                subjectsContainer.innerHTML = '';
                if (data.subjects && data.subjects.length > 0) {
                    data.subjects.forEach(subject => {
                        const isChecked = selectedSubjectIds.includes(String(subject.id)) ? 'checked' : '';
                        const label = document.createElement('label');
                        label.className = 'chip';
                        label.innerHTML = `<input type="checkbox" name="subjects" value="${subject.id}" ${isChecked}><span>${subject.name}</span>`;
                        subjectsContainer.appendChild(label);
                    });
                } else {
                    subjectsContainer.innerHTML = '<p class="text-sm text-gray-500">Нет предметов для этих фильтров.</p>';
                }
            }).catch(e => { console.error(e); });
        };

        ['quarters', 'schools', 'test_numbers', 'days'].forEach(filterName => {
            const card = form.querySelector(`[data-filter="${filterName}"]`);
            if (!card) return;
            const paramValues = new URLSearchParams(window.location.search).getAll(filterName);
            if (paramValues.length > 0) {
                card.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    if (paramValues.includes(cb.value)) { cb.checked = true; }
                });
            }
        });

        if (schoolsCard) { schoolsCard.addEventListener('change', () => {
            classesContainer.innerHTML = '<p class="text-sm text-gray-500">Загрузка...</p>';
            subjectsContainer.innerHTML = '<p class="text-sm text-gray-500">...</p>';
            loadClasses();
        });}
        [classesCard, testsCard, daysCard].forEach(card => {
            if (card) { card.addEventListener('change', loadSubjects); }
        });
        loadSubjects();
    }

    // --- ЛОГИКА ДЛЯ ГРАФИКОВ И ТАБОВ ---
    {% if has_results %}
        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const target = document.getElementById(tab.dataset.tab);
                tabContents.forEach(tc => tc.classList.remove('active'));
                if (target) target.classList.add('active');
            });
        });

        const colorPalette = ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#8b5cf6'];
        let colorIndex = 0;
        function getNextColor(opacity = 1) {
            const hex = colorPalette[colorIndex % colorPalette.length];
            colorIndex++;
            const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        }

        // --- ✨ ИСПРАВЛЕНИЕ: Этот график теперь рисуется как 'bar' (столбчатый) ---
        const comparisonCanvas = document.getElementById('comparisonChart');
        if (comparisonCanvas) {
            const comparisonData = JSON.parse(comparisonCanvas.dataset.chartData);
            comparisonData.datasets.forEach(ds => {
                if (ds.type !== 'line') { ds.backgroundColor = getNextColor(0.8); } 
                else { ds.borderColor = '#ef4444'; }
            });
            new Chart(comparisonCanvas, {
                type: 'bar', // ✨ ТИП ИЗМЕНЕН С 'radar' НА 'bar'
                data: comparisonData,
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'top' },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            formatter: (v) => v + '%',
                            color: '#1f2937'
                        }
                    },
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });
        }
        
        // --- ✨ ИСПРАВЛЕНИЕ: Этот график теперь отображается как горизонтальный столбчатый (indexAxis: 'y') ---
        const barCanvas = document.getElementById('overallPerformanceChart');
        if (barCanvas) {
            const barData = JSON.parse(barCanvas.dataset.chartData);
            barData.datasets.forEach(ds => {
                ds.backgroundColor = getNextColor(0.8);
            });
            new Chart(barCanvas, {
                type: 'bar',
                data: barData,
                options: {
                    indexAxis: 'y', // ✨ Делает график горизонтальным для лучшей читаемости
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }, // Легенда не нужна, т.к. только один набор данных
                        datalabels: {
                            anchor: 'end',
                            align: 'right', // Метки справа от столбцов
                            formatter: (v) => v + '%',
                            color: '#1f2937'
                        }
                    },
                    scales: { x: { beginAtZero: true, max: 100 } }
                }
            });
        }

        const trendCanvas = document.getElementById('trendChart');
        if (trendCanvas) {
            const trendData = JSON.parse(trendCanvas.dataset.chartData);
            trendData.datasets.forEach(ds => {
                const color = getNextColor(0.2);
                const borderColor = getNextColor(1);
                ds.backgroundColor = color;
                ds.borderColor = borderColor;
                ds.pointBackgroundColor = borderColor;
            });
            new Chart(trendCanvas, { type: 'line', data: trendData, options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'top' }}}});
        }
    {% endif %}
});
</script>

{% endblock %}