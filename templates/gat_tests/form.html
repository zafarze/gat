{% extends 'components/form_view.html' %}

{% block form_content %}
    {% csrf_token %}

    {% if form.non_field_errors %}
        <div class="p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-100">
            {% for error in form.non_field_errors %}{{ error }}{% endfor %}
        </div>
    {% endif %}

    {# Отображаем все поля, КРОМЕ 'subjects', стандартным образом #}
    {% for field in form %}
        {% if field.name != 'subjects' %}
            <div class="mb-4">
                <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ field.label }}</label>
                {{ field }}
                {% if field.errors %}<p class="mt-1 text-sm text-red-600">{{ field.errors|striptags }}</p>{% endif %}
            </div>
        {% endif %}
    {% endfor %}

    {# Специальный блок для красивого вывода флажков 'subjects' #}
    <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.subjects.label }}</label>
        <div id="subjects-container" class="p-4 border border-gray-300 rounded-md grid grid-cols-2 md:grid-cols-3 gap-4">
            {{ form.subjects }}
        </div>
         {% if form.subjects.errors %}<p class="mt-1 text-sm text-red-600">{{ form.subjects.errors|striptags }}</p>{% endif %}
    </div>

    <div class="mt-8 flex justify-end space-x-4">
        <a href="{% url cancel_url %}" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300">Отмена</a>
        <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">Сохранить</button>
    </div>
{% endblock %}

{% block javascript %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const classSelect = document.getElementById('id_school_class');
            const quarterSelect = document.getElementById('id_quarter');
            const testNumberInput = document.getElementById('id_test_number');
            const subjectsContainer = document.getElementById('subjects-container');

            function fetchAndHighlightSubjects() {
                const classId = classSelect.value;
                const quarterId = quarterSelect.value;
                const testNumber = testNumberInput.value;

                if (!classId || !quarterId || !testNumber) {
                    subjectsContainer.querySelectorAll('label').forEach(label => {
                        label.classList.remove('bg-yellow-100', 'p-2', 'rounded-md');
                    });
                    return;
                }

                const apiUrl = `{% url 'api_get_previous_subjects' %}?class_id=${classId}&quarter_id=${quarterId}&test_number=${testNumber}`;

                fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        const previousSubjectIds = data.subject_ids;
                        subjectsContainer.querySelectorAll('label').forEach(label => {
                            const checkbox = label.querySelector('input[type="checkbox"]');
                            const subjectId = parseInt(checkbox.value, 10);
                            label.classList.remove('bg-yellow-100', 'p-2', 'rounded-md');
                            if (previousSubjectIds.includes(subjectId)) {
                                label.classList.add('bg-yellow-100', 'p-2', 'rounded-md');
                            }
                        });
                    });
            }

            classSelect.addEventListener('change', fetchAndHighlightSubjects);
            quarterSelect.addEventListener('change', fetchAndHighlightSubjects);
            testNumberInput.addEventListener('input', fetchAndHighlightSubjects);
            fetchAndHighlightSubjects();
        });
    </script>
{% endblock %}