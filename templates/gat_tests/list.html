{% extends "base.html" %}
{% load static %} {# –î–æ–±–∞–≤—å static, –µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç #}

{% block title %}{{ title }}{% endblock %} {# –î–æ–±–∞–≤—å title –±–ª–æ–∫ #}

{% block content %}
<div
    x-data="{
        showModal: false,
        showDeleteModal: false,
        deleteUrl: '',
        deleteItemName: '',
        deleteSchoolId: '' {# –≠—Ç–æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä, –∫–∞–∂–µ—Ç—Å—è, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ç–≤–æ–µ–π –ª–æ–≥–∏–∫–µ —É–¥–∞–ª–µ–Ω–∏—è #}
    }"
    @keydown.escape.window="showModal = false; showDeleteModal = false"
    {# –£–±–∏—Ä–∞–µ–º @close-modal –∏ @close-delete-modal, —Ç–∞–∫ –∫–∞–∫ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ HTMX Trigger #}
>
    <div class="page-header">
        <div>
            {# –°—Å—ã–ª–∫–∞ –Ω–∞–∑–∞–¥ - –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∏–ª–∏ —É–±—Ä–∞—Ç—å –ø–æ –∂–µ–ª–∞–Ω–∏—é #}
            {# <a href="{% url 'core:management' %}" class="back-link">&larr; –ù–∞–∑–∞–¥ –≤ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a> #}
            <h1 class="page-title mt-1">{{ title }}</h1>
        </div>
        {# --- –ö–Ω–æ–ø–∫–∞ –ù–∞–∑–Ω–∞—á–∏—Ç—å GAT –¢–µ—Å—Ç --- #}
        {% if user.is_superuser %}
        <button
                @click="showModal = true" {# –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ Alpine #}
                hx-get="{% url 'core:gat_test_add' %}" {# URL –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ä–º—ã #}
                hx-target="#modal-content" {# –ö—É–¥–∞ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ñ–æ—Ä–º—É #}
                hx-swap="innerHTML" {# –ó–∞–º–µ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ #}
                hx-indicator="#modal-loading-indicator" {# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ #}
                class="modern-btn primary flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
            <span>–ù–∞–∑–Ω–∞—á–∏—Ç—å GAT –¢–µ—Å—Ç</span>
        </button>
        {% endif %}
    </div>

    {# --- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ --- #}
    <div class="space-y-8" id="test-list-container">
        {# –í–∫–ª—é—á–∞–µ–º —á–∞—Å—Ç–∏—á–Ω—ã–π —à–∞–±–ª–æ–Ω, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–Ω–¥–µ—Ä–∏—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ —à–∫–æ–ª #}
        {% include 'gat_tests/partials/_test_list_content.html' %}
    </div>

    {# --- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è C–æ–∑–¥–∞–Ω–∏—è/–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è --- #}
    {# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–∫–Ω–∞ –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–≤–æ–µ–π, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Alpine showModal #}
    <div x-show="showModal"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-40 bg-gray-900 bg-opacity-50 overflow-y-auto" style="display: none;" x-cloak>
        <div class="flex min-h-full items-center justify-center p-4">
            {# --- üëá –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–¥–µ—Å—å üëá --- #}
            {# –£–±–∏—Ä–∞–µ–º @click.away (–±—É–¥–µ—Ç –≤–Ω—É—Ç—Ä–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞) #}
            {# –î–æ–±–∞–≤–ª—è–µ–º max-h-[90vh] –∏ overflow-y-auto –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞ #}
            <div id="modal-content-wrapper" class="w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                 {# –°—é–¥–∞ HTMX –∑–∞–≥—Ä—É–∑–∏—Ç form_modal.html, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç _form_content.html #}
                <div id="modal-content">
                    {# –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ #}
                    <div id="modal-loading-indicator" class="flex items-center justify-center text-white p-8">
                        <svg class="animate-spin h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="ml-3">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ä–º—ã...</span>
                    </div>
                </div>
            </div>
             {# --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô --- #}
        </div>
    </div>

    {# --- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –£–¥–∞–ª–µ–Ω–∏—è --- #}
    {# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–∫–Ω–∞ –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–≤–æ–µ–π #}
    <div x-show="showDeleteModal"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4" style="display: none;" x-cloak>
        <div @click.away="showDeleteModal = false" class="bg-white rounded-xl shadow-xl p-8 max-w-md w-full text-center">
            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:h-10 sm:w-10">
                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mt-5">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ</h3>
            <div class="mt-2 text-gray-600">
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç</p>
                <p class="font-bold" x-text="deleteItemName"></p>
                {# --- üëá –í–ê–ñ–ù–û: –£—Ç–æ—á–Ω–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ üëá --- #}
                <div class="text-red-700 bg-red-100 p-3 rounded-md mt-4 text-sm"><strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É—á–µ–Ω–∏–∫–æ–≤ –ø–æ —ç—Ç–æ–º—É —Ç–µ—Å—Ç—É <strong class="underline">–ù–ï –±—É–¥—É—Ç</strong> —É–¥–∞–ª–µ–Ω—ã. <a href="#" @click.prevent="alert('–ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å—Å—ã–ª–∫–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤')" class="text-indigo-600 hover:underline">–£–¥–∞–ª–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–¥–µ–ª—å–Ω–æ?</a></div>
            </div>
            <div class="mt-8 flex justify-center items-center gap-4">
                {# –§–æ—Ä–º–∞ –¥–ª—è CSRF-—Ç–æ–∫–µ–Ω–∞ #}
                <form id="delete-form-gat-tests-{{ school.id }}">{% csrf_token %}</form>
                <button type="button" @click="showDeleteModal = false" class="modern-btn secondary">–û—Ç–º–µ–Ω–∞</button>
                {# --- üëá –ò–∑–º–µ–Ω–µ–Ω htmx.ajax –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π HTMX POST üëá --- #}
                <button type="button"
                        hx-post="" {# URL –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ Alpine #}
                        :hx-post="deleteUrl" {# –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º URL –∏–∑ Alpine #}
                        hx-target="#test-list-container" {# –¶–µ–ª—å - –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–µ—Å—Ç–æ–≤ #}
                        hx-swap="innerHTML" {# –ó–∞–º–µ–Ω–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–ø–∏—Å–∫–∞ #}
                        hx-include="#delete-form-gat-tests-{{ school.id }}" {# –í–∫–ª—é—á–∞–µ–º CSRF #}
                        @click="showDeleteModal = false" {# –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞ #}
                        class="modern-btn danger">
                        –î–∞, —É–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç
                </button>
                 {# --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô --- #}
            </div>
        </div>
    </div>
</div>

{# –î–æ–±–∞–≤–∏–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –∏–∑ HTMX Trigger #}
<script>
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        const triggerHeader = evt.detail.xhr.getResponseHeader('HX-Trigger');
        if (triggerHeader) {
            try {
                const triggers = JSON.parse(triggerHeader);
                const alpineData = Alpine.closestDataStack(evt.detail.target)[0]; // –ü–æ–ª—É—á–∞–µ–º x-data
                if (triggers['close-modal'] && alpineData && alpineData.hasOwnProperty('showModal')) {
                    alpineData.showModal = false;
                    const modalContent = document.getElementById('modal-content');
                    if (modalContent) modalContent.innerHTML = ''; // –û—á–∏—â–∞–µ–º
                }
                if (triggers['close-delete-modal'] && alpineData && alpineData.hasOwnProperty('showDeleteModal')) {
                    alpineData.showDeleteModal = false;
                    // –ö–æ–Ω—Ç–µ–Ω—Ç –æ–∫–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—á–µ–Ω, –æ—á–∏—â–∞—Ç—å –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
                }
            } catch (e) { console.error('Error parsing HX-Trigger for modals:', e); }
        }
    });
</script>
{% endblock %}