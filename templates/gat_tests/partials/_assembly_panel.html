{# D:\GAT\templates\gat_tests\partials\_assembly_panel.html #}
{% load widget_tweaks %}
{% csrf_token %} {# Добавляем CSRF-токен для HTMX POST запросов #}

<h2 class="text-xl font-semibold mb-6 border-b pb-3">2. Выбор вопросов из Банка</h2>

{# --- ✨ БЛОК СТАТИСТИКИ СЛОЖНОСТИ (SMART SCALE) ✨ --- #}
{% if difficulty_stats %}
<div class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm">
    <div class="flex justify-between items-end mb-3">
        <h3 class="text-sm font-bold text-gray-700">Баланс сложности</h3>
        <span class="text-xs text-gray-500">Всего вопросов: <strong>{{ added_questions|length }}</strong></span>
    </div>
    
    <div class="space-y-3">
        {# EASY (Легкие) #}
        <div>
            <div class="flex justify-between text-xs mb-1">
                <span class="font-medium text-green-700">Легкие (Цель: {{ difficulty_stats.easy.target }}%)</span>
                <span class="font-bold {% if difficulty_stats.easy.percent != difficulty_stats.easy.target %}text-amber-600{% else %}text-green-600{% endif %}">
                    {{ difficulty_stats.easy.percent }}%
                </span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-green-500 h-2 rounded-full transition-all duration-500" 
                     style="width: {{ difficulty_stats.easy.percent }}%"></div>
            </div>
        </div>

        {# MEDIUM (Средние) #}
        <div>
            <div class="flex justify-between text-xs mb-1">
                <span class="font-medium text-yellow-700">Средние (Цель: {{ difficulty_stats.medium.target }}%)</span>
                <span class="font-bold {% if difficulty_stats.medium.percent != difficulty_stats.medium.target %}text-amber-600{% else %}text-green-600{% endif %}">
                    {{ difficulty_stats.medium.percent }}%
                </span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-yellow-500 h-2 rounded-full transition-all duration-500" 
                     style="width: {{ difficulty_stats.medium.percent }}%"></div>
            </div>
        </div>

        {# HARD (Сложные) #}
        <div>
            <div class="flex justify-between text-xs mb-1">
                <span class="font-medium text-red-700">Сложные (Цель: {{ difficulty_stats.hard.target }}%)</span>
                <span class="font-bold {% if difficulty_stats.hard.percent != difficulty_stats.hard.target %}text-amber-600{% else %}text-green-600{% endif %}">
                    {{ difficulty_stats.hard.percent }}%
                </span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-red-500 h-2 rounded-full transition-all duration-500" 
                     style="width: {{ difficulty_stats.hard.percent }}%"></div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{# --- КОНЕЦ БЛОКА СТАТИСТИКИ --- #}


{# --- Контейнер для списка ДОСТУПНЫХ вопросов --- #}
<div class="mb-8">
    <h3 class="text-lg font-medium text-gray-700 mb-3">Доступные вопросы ({{ available_questions|length }})</h3>
    {# TODO: Добавить фильтры здесь позже #}
    <div class="border rounded-lg max-h-96 overflow-y-auto divide-y">
        {% for question in available_questions %}
            {# Проверяем, добавлен ли уже этот вопрос #}
            {% if question.id not in added_question_ids %}
                <div class="p-3 flex justify-between items-center hover:bg-gray-50">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            {# Метка сложности #}
                            {% if question.difficulty == 'EASY' %}
                                <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-800">EASY</span>
                            {% elif question.difficulty == 'MEDIUM' %}
                                <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-yellow-100 text-yellow-800">MEDIUM</span>
                            {% else %}
                                <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-800">HARD</span>
                            {% endif %}
                            
                            <p class="text-xs text-gray-500">{{ question.subject.name }} / {{ question.topic.name }}</p>
                        </div>
                        <p class="text-sm font-medium text-gray-900">{{ question.text|truncatechars:80 }}</p>
                    </div>
                    
                    {# --- ✨ ОЖИВЛЕННАЯ КНОПКА "Добавить" ✨ --- #}
                    <button type="button" 
                            class="modern-btn success small"
                            hx-post="{% url 'core:gat_test_add_question' test_id question.id %}"
                            hx-target="#question-selection-panel"
                            hx-swap="outerHTML"
                            hx-include="[name='csrfmiddlewaretoken']">
                        Добавить
                    </button>
                    {# --- ✨ КОНЕЦ ✨ --- #}
                </div>
            {% endif %}
        {% empty %}
            <p class="p-4 text-center text-gray-500 text-sm">Нет доступных вопросов для этой параллели.</p>
        {% endfor %}
    </div>
</div>

{# --- Контейнер для списка ВЫБРАННЫХ вопросов --- #}
<div>
    <h3 class="text-lg font-medium text-gray-700 mb-3">Выбранные вопросы ({{ added_questions|length }})</h3>
     
     {# --- БЛОК: Счетчик по предметам --- #}
     {% if subject_counts %}
     <div class="flex flex-wrap gap-2 mb-4 text-xs">
        {% for subject_name, count in subject_counts.items %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full font-medium bg-blue-100 text-blue-800">
                {{ subject_name }}: {{ count }}
            </span>
        {% endfor %}
     </div>
     {% endif %}
     
    <div class="border rounded-lg max-h-96 overflow-y-auto divide-y">
        {% for question in added_questions %}
            <div class="p-3 flex justify-between items-center hover:bg-gray-50">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        {# Метка сложности #}
                        {% if question.difficulty == 'EASY' %}
                            <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-800">EASY</span>
                        {% elif question.difficulty == 'MEDIUM' %}
                            <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-yellow-100 text-yellow-800">MEDIUM</span>
                        {% else %}
                            <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-800">HARD</span>
                        {% endif %}

                        <p class="text-xs text-gray-500">{{ question.subject.name }} / {{ question.topic.name }}</p>
                    </div>
                    <p class="text-sm font-medium text-gray-900">{{ question.text|truncatechars:80 }}</p>
                </div>

                {# --- ✨ ОЖИВЛЕННАЯ КНОПКА "Удалить" ✨ --- #}
                <button type="button" 
                        class="modern-btn danger small"
                        hx-post="{% url 'core:gat_test_remove_question' test_id question.id %}"
                        hx-target="#question-selection-panel"
                        hx-swap="outerHTML"
                        hx-include="[name='csrfmiddlewaretoken']">
                    Удалить
                </button>
                {# --- ✨ КОНЕЦ ✨ --- #}
            </div>
        {% empty %}
            <p class="p-4 text-center text-gray-500 text-sm">Еще не выбрано ни одного вопроса.</p>
        {% endfor %}
    </div>
</div>