{# D:\GAT\templates\bank_questions\partials\_form_content.html #}
{% load widget_tweaks %}

<div id="modal-form-content" class="h-full flex flex-col bg-white rounded-xl"
     x-data='questionFormLogic({
        options: {{ options_formset_initial_json|default:"[]"|safe }},
        minOptions: {{ options_formset.min_num|default:2 }},
        maxOptions: {{ options_formset.max_num|default:5 }}
     })'
     x-init="initLogic()"
>
    <form
        {% if object %}
        hx-post="{% url 'core:bank_question_edit' object.pk %}"
        {% else %}
        hx-post="{% url 'core:bank_question_add' %}"
        {% endif %}
        hx-target="#modal-form-content"
        hx-swap="outerHTML"
        hx-encoding="multipart/form-data"
        enctype="multipart/form-data"
        method="post"
        class="flex flex-col h-full"
    >
        {% csrf_token %}
        {{ options_formset.management_form }}

        {# --- УДАЛЕНО: Верхний блок с заголовком и крестиком (он дублировался) --- #}

        {# --- СКРОЛЛИРУЕМЫЙ КОНТЕНТ --- #}
        <div class="p-8 overflow-y-auto flex-1 space-y-6">
            
            {# Блок ошибок #}
            {% if form.non_field_errors or options_formset.non_form_errors %}
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                    {{ form.non_field_errors }}
                    {{ options_formset.non_form_errors }}
                </div>
            {% endif %}

            {# --- Поля Вопроса --- #}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {# Левая колонка: Тема и Сложность #}
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Тема <span class="text-red-500">*</span></label>
                        {% render_field form.topic class+="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" %}
                        <div class="text-xs text-red-600 mt-1">{{ form.topic.errors }}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Сложность <span class="text-red-500">*</span></label>
                        {% render_field form.difficulty class+="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" %}
                        <div class="text-xs text-red-600 mt-1">{{ form.difficulty.errors }}</div>
                    </div>
                </div>

                {# Правая колонка: Текст вопроса #}
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Текст вопроса <span class="text-red-500">*</span></label>
                    {% render_field form.text class+="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" rows="3" placeholder="Введите текст вопроса..." %}
                    <div class="text-xs text-red-600 mt-1">{{ form.text.errors }}</div>
                </div>

                {# Картинка вопроса (на всю ширину) #}
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Изображение к вопросу (необязательно)</label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:bg-gray-50 transition">
                        <div class="space-y-1 text-center">
                            {% if object and object.question_image %}
                                <div class="mb-2">
                                    <img src="{{ object.question_image.url }}" alt="Current" class="mx-auto h-32 object-contain rounded">
                                    <div class="flex items-center justify-center mt-2 space-x-2">
                                        <input type="checkbox" name="question_image-clear" id="question_image-clear" class="h-4 w-4 text-indigo-600 rounded">
                                        <label for="question_image-clear" class="text-sm text-red-600 cursor-pointer">Удалить</label>
                                    </div>
                                </div>
                            {% else %}
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            {% endif %}
                            <div class="text-sm text-gray-600">
                                <label for="{{ form.question_image.id_for_label }}" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none">
                                    <span>Загрузить файл</span>
                                    {% render_field form.question_image class="sr-only" %}
                                </label>
                            </div>
                            <p class="text-xs text-gray-500">PNG, JPG до 5MB</p>
                        </div>
                    </div>
                </div>
            </div>

            {# --- Варианты Ответов --- #}
            <fieldset class="mt-8 pt-6 border-t border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <legend class="text-base font-medium text-gray-900">Варианты ответов</legend>
                    <span class="text-sm text-gray-500 bg-yellow-50 px-2 py-1 rounded border border-yellow-200">Выберите правильный радио-кнопкой</span>
                </div>

                <div class="space-y-3">
                    <template x-for="(option, index) in options" :key="index">
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg border border-gray-200 transition hover:border-indigo-300" x-show="!option.DELETE">
                            
                            {# Скрытые поля #}
                            <input type="hidden" :name="`options-${index}-id`" :value="option.id">
                            <input type="checkbox" :name="`options-${index}-DELETE`" x-model="option.DELETE" value="on" class="hidden">
                            
                            {# 1. Радио (Правильный) #}
                            <div class="pt-3">
                                <input type="radio" 
                                       name="correct_option_radio_group" 
                                       :checked="option.is_correct"
                                       @click="setCorrect(index)"
                                       class="h-5 w-5 text-green-600 focus:ring-green-500 border-gray-300 cursor-pointer"
                                       title="Это правильный ответ">
                                <input type="checkbox" :name="`options-${index}-is_correct`" x-model="option.is_correct" class="hidden">
                            </div>

                            {# 2. Текст и Картинка #}
                            <div class="flex-1 space-y-2">
                                <input type="text" 
                                       :name="`options-${index}-text`" 
                                       x-model="option.text" 
                                       placeholder="Текст ответа" 
                                       class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                
                                {# Блок картинки варианта #}
                                <div class="flex items-center space-x-3">
                                    {# Кнопка загрузки (скрепка) #}
                                    <label class="cursor-pointer inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none">
                                        <svg class="h-4 w-4 mr-1 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                        <span x-text="option.option_image_url ? 'Изменить фото' : 'Добавить фото'"></span>
                                        {# INPUT FILE для варианта #}
                                        <input type="file" :name="`options-${index}-option_image`" class="sr-only" accept="image/*"
                                               @change="
                                                   const file = $event.target.files[0];
                                                   if (file) {
                                                       option.option_image_url = URL.createObjectURL(file);
                                                   }
                                               ">
                                    </label>

                                    {# Превью картинки (если есть) #}
                                    <template x-if="option.option_image_url">
                                        <div class="relative group">
                                            <img :src="option.option_image_url" class="h-10 w-10 object-cover rounded border border-gray-300">
                                            {# Чекбокс очистки (для Django) #}
                                            <label class="flex items-center space-x-1 ml-2 cursor-pointer">
                                                <input type="checkbox" :name="`options-${index}-option_image-clear`" class="h-3 w-3 rounded border-gray-300 text-red-600">
                                                <span class="text-xs text-red-500">Удалить</span>
                                            </label>
                                        </div>
                                    </template>
                                </div>
                            </div>

                        </div>
                    </template>
                </div>
            </fieldset>
        </div>

        {# --- ФУТЕР --- #}
        <div class="p-6 bg-gray-50 border-t flex justify-end items-center gap-4 rounded-b-xl sticky bottom-0 z-10">
            <button type="button" @click="isModalOpen = false" class="btn btn-secondary">Отмена</button>
            <button type="submit" class="btn btn-primary px-8">Сохранить вопрос</button>
        </div>
    </form>
</div>