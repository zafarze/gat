{# D:\GAT\templates\bank_questions\list.html #}

{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
    <div>
        <h1 class="text-3xl font-bold text-gray-800">{{ title }}</h1>
        <p class="text-gray-500 text-sm mt-1">Управление базой вопросов</p>
    </div>
    
    <div class="flex flex-wrap gap-3">
        {# --- КНОПКА 1: ИМПОРТ (Новая) --- #}
        <button
            type="button"
            id="btn-import-questions"
            class="group flex items-center px-5 py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-medium rounded-lg shadow-md transition-all duration-200 hover:shadow-lg transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500"
        >
            <svg class="h-5 w-5 mr-2 text-emerald-100 group-hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            <span>Импорт (Excel/Word)</span>
        </button>

        {# --- КНОПКА 2: ДОБАВИТЬ (Обновленная) --- #}
        <button
            @click.prevent="$dispatch('open-modal', { url: '{% url add_url %}' })"
            class="group flex items-center px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-lg shadow-md transition-all duration-200 hover:shadow-lg transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
        >
            <svg class="h-5 w-5 mr-2 text-indigo-100 group-hover:text-white transition-colors" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
            </svg>
            <span>Добавить вопрос</span>
        </button>
    </div>
</div>

{# --- Фильтры --- #}
<div class="mb-6 p-5 bg-white rounded-xl shadow-sm border border-gray-100">
    <form hx-get="{% url 'core:bank_question_list' %}"
          hx-target="#bank_question-table-container"
          hx-swap="outerHTML"
          hx-indicator="#loading-indicator">
          
        <div class="grid grid-cols-1 md:grid-cols-3 gap-5 items-end">
            {# Фильтр по Теме #}
            <div class="md:col-span-2">
                <label for="topic_filter" class="block text-sm font-semibold text-gray-700 mb-1">Фильтр по теме:</label>
                <div class="relative">
                    <select name="topic" id="topic_filter" class="appearance-none block w-full pl-4 pr-10 py-2.5 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg transition shadow-sm">
                        <option value="">Все темы</option>
                        {% regroup topics_for_filter by subject as topics_by_subject %}
                        {% for subject_group in topics_by_subject %}
                            <optgroup label="{{ subject_group.grouper.name }}">
                                {% for topic in subject_group.list %}
                                <option value="{{ topic.id }}" {% if request.GET.topic == topic.id|stringformat:"s" %}selected{% endif %}>
                                    {{ topic.name }} ({{ topic.school_class.name }} кл.)
                                </option>
                                {% endfor %}
                            </optgroup>
                        {% endfor %}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                </div>
            </div>

            {# Кнопки фильтрации #}
            <div class="flex space-x-2">
                <button type="submit" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2.5 px-4 rounded-lg transition focus:outline-none focus:ring-2 focus:ring-gray-400">
                    Применить
                </button>
                <a href="{% url 'core:bank_question_list' %}" class="flex-none bg-white border border-gray-300 hover:bg-gray-50 text-gray-500 font-medium py-2.5 px-4 rounded-lg transition flex items-center justify-center" title="Сбросить">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </a>
            </div>
        </div>
    </form>
</div>

{# --- Контейнер для таблицы --- #}
<div id="bank_question-table-container">
    {% include 'bank_questions/_table.html' with items=items page_obj=page_obj %}
</div>

{# --- Индикатор загрузки --- #}
<div id="loading-indicator" class="htmx-indicator fixed bottom-6 right-6 bg-gray-900 text-white px-5 py-3 rounded-lg shadow-xl z-50 flex items-center space-x-3">
    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <span class="font-medium">Загрузка...</span>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const importBtn = document.getElementById('btn-import-questions');
        const topicSelect = document.getElementById('topic_filter');

        if (importBtn && topicSelect) {
            importBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const selectedTopicId = topicSelect.value;

                if (!selectedTopicId) {
                    // Если тема не выбрана, показываем красивое предупреждение через Alpine/Django events или alert
                    alert('Пожалуйста, выберите ТЕМУ в фильтре ниже, чтобы загрузить в неё вопросы.');
                    // Фокусируемся на селекте
                    topicSelect.focus();
                    // Можно добавить визуальный эффект (тряска или красная рамка)
                    topicSelect.classList.add('ring-2', 'ring-red-500', 'border-red-500');
                    setTimeout(() => {
                        topicSelect.classList.remove('ring-2', 'ring-red-500', 'border-red-500');
                    }, 2000);
                    return;
                }

                // Если тема выбрана, открываем модальное окно импорта с ID темы
                window.dispatchEvent(new CustomEvent('open-modal', {
                    detail: {
                        url: `{% url 'core:bank_question_import' %}?topic_id=${selectedTopicId}`
                    }
                }));
            });
        }
    });
</script>
{% endblock %}