{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-8">
    <div class="bg-white shadow-lg rounded-2xl overflow-hidden">
        <div class="p-6 border-b">
            <h1 class="text-3xl font-bold text-gray-800">{{ title }}</h1>
        </div>
        
        <form method="post" class="p-6 space-y-6" enctype="multipart/form-data">
            {% csrf_token %}
            
            <fieldset class="space-y-4">
                <legend class="text-xl font-semibold text-gray-700 mb-2">Данные для входа</legend>
                {{ form|crispy }}
            </fieldset>

            <hr>

            <fieldset class="space-y-4">
                <legend class="text-xl font-semibold text-gray-700 mb-2">Настройки профиля и роли</legend>
                
                <div id="role-field-wrapper">{{ profile_form.role|as_crispy_field }}</div>
                <div id="photo-field-wrapper">{{ profile_form.photo|as_crispy_field }}</div>

                <div id="schools-field-wrapper" class="role-specific-field" style="display: none;">{{ profile_form.schools|as_crispy_field }}</div>
                <div id="school-field-wrapper" class="role-specific-field" style="display: none;">{{ profile_form.school|as_crispy_field }}</div>
                
                <div id="subjects-field-wrapper" class="role-specific-field" style="display: none;">
                    <div id="subjects-field-container">
                        {{ profile_form.subjects|as_crispy_field }}
                    </div>
                </div>
                
                <div id="homeroom_class-field-wrapper" class="role-specific-field" style="display: none;">{{ profile_form.homeroom_class|as_crispy_field }}</div>
                <div id="student-field-wrapper" class="role-specific-field" style="display: none;">{{ profile_form.student|as_crispy_field }}</div>
            </fieldset>

            <div class="flex justify-end pt-4 border-t gap-3 mt-6">
                <a href="{% url 'core:user_list' %}" class="btn btn-secondary">Отмена</a>
                <button type="submit" class="btn btn-primary">Сохранить</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const roleSelect = document.getElementById('id_role');
    if (!roleSelect) return;

    const roleFieldMapping = {
        'GENERAL_DIRECTOR': [],
        'DIRECTOR': ['schools-field-wrapper'],
        // ✨ ИЗМЕНЕНИЕ: Убираем 'school-field-wrapper' из списка для Эксперта
        'EXPERT': ['subjects-field-wrapper'],
        'TEACHER': ['school-field-wrapper', 'subjects-field-wrapper'],
        'HOMEROOM_TEACHER': ['school-field-wrapper', 'homeroom_class-field-wrapper', 'subjects-field-wrapper'],
        'STUDENT': ['student-field-wrapper']
    };

    function toggleRoleSpecificFields() {
        const selectedRole = roleSelect.value;
        document.querySelectorAll('.role-specific-field').forEach(el => {
            el.style.display = 'none';
        });
        const fieldsToShow = roleFieldMapping[selectedRole];
        if (fieldsToShow) {
            fieldsToShow.forEach(fieldId => {
                const wrapper = document.getElementById(fieldId);
                if (wrapper) {
                    wrapper.style.display = 'block';
                }
            });
        }
    }

    toggleRoleSpecificFields();
    roleSelect.addEventListener('change', toggleRoleSpecificFields);
});
</script>
{% endblock %}