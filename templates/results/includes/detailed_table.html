{% load custom_filters %}

<table class="min-w-full divide-y divide-gray-200">
    <thead class="bg-gray-50">
        {# Заголовки таблицы #}
        <tr>
            <th rowspan="2" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase sticky left-0 bg-gray-50 z-10 w-12">№</th>
            <th rowspan="2" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase sticky left-12 bg-gray-50 z-10 min-w-[250px]">Ф.И.О</th>
            <th rowspan="2" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Класс</th>
            
            {% for header in table_header %}
            <th colspan="{{ header.questions|length }}" class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase border-l">{{ header.subject.name }}</th>
            {% endfor %}
            
            <th rowspan="2" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase border-l">Итог</th>
        </tr>
        <tr>
            {% for header in table_header %}
                {% for q_num in header.questions %}
                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 border-l">{{ q_num }}</th>
                {% endfor %}
            {% endfor %}
        </tr>
    </thead>
    <tbody class="bg-white divide-y divide-gray-200">
        {% for data in students_data %}
        <tr class="hover:bg-gray-50 group">
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 sticky left-0 bg-white group-hover:bg-gray-50 z-10">{{ forloop.counter }}</td>
            
            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium sticky left-12 bg-white group-hover:bg-gray-50 z-10">
                <a href="{% url 'student_progress' data.student.id %}" class="text-indigo-600 hover:text-indigo-800 hover:underline">
                    {{ data.student }}
                </a>
            </td>

            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">{{ data.student.school_class.name }}</td>
            
            {% for header in table_header %}
                {% with subject_id_str=header.subject.id|stringformat:"s" %}
                {% with answers=data.result.scores|get_item:subject_id_str %}
                    {% for q_num in header.questions %}
                        {% with answer=answers|get_item:forloop.counter0 %}
                            <td class="px-2 py-4 text-center text-sm border-l
                                {% if answer == 1 %}
                                    bg-green-50 text-green-800 font-bold
                                {% elif answer == 0 %}
                                    bg-red-50 text-red-800
                                {% else %}
                                    text-gray-400
                                {% endif %}
                            ">
                                {% if answer == 1 %}1{% elif answer == 0 %}0{% else %}-{% endif %}
                            </td>
                        {% endwith %}
                    {% endfor %}
                {% endwith %}
                {% endwith %}
            {% endfor %}

            <td class="px-4 py-4 whitespace-nowrap text-sm text-center font-bold text-gray-900 border-l">{{ data.total_score }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="100%" class="px-6 py-4 text-center text-gray-500">Нет данных для отображения.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>